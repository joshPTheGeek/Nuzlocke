<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soul Link Sync</title>
    <!-- React & Tailwind -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --gba-purple: #2d1b4e;
            --gba-screen-bg: #e0f8cf;
        }
        body { 
            font-family: 'Press Start 2P', cursive; 
            background: #202020; 
            color: #333; 
            margin: 0;
            padding: 0;
        }
        .pixel-shadow { box-shadow: 4px 4px 0 rgba(0,0,0,0.5); }
        .gba-screen { 
            background-color: var(--gba-screen-bg); 
            min-height: 75vh; 
            position: relative;
            box-shadow: inset 0 0 40px rgba(0,0,0,0.1);
        }
        .status-dead { 
            filter: grayscale(100%); 
            opacity: 0.7; 
            background: #cbd5e1 !important; 
        }
        input { 
            font-family: 'Press Start 2P', cursive; 
            outline: none;
        }
        .scanline {
            width: 100%;
            height: 2px;
            background: rgba(0, 0, 0, 0.1);
            position: absolute;
            z-index: 10;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, collection, query, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCX6il-7t1C_mFOQq8KEL_NuOIYOGKpgws",
            authDomain: "josh-and-tom-nuzlocke.firebaseapp.com",
            projectId: "josh-and-tom-nuzlocke",
            storageBucket: "josh-and-tom-nuzlocke.firebasestorage.app",
            messagingSenderId: "5969970030",
            appId: "1:596955970030:web:4296388aa3375eb6ff"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Global access for the React component
        window.db = db;
        window.auth = auth;
        window.fb = { collection, doc, onSnapshot, setDoc, query, orderBy, deleteDoc, signInWithEmailAndPassword, onAuthStateChanged, signOut };
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const App = () => {
            const [links, setLinks] = useState([]);
            const [isAdmin, setIsAdmin] = useState(false);
            const [showLogin, setShowLogin] = useState(false);
            const [email, setEmail] = useState("");
            const [password, setPassword] = useState("");
            const [errorLog, setErrorLog] = useState("");
            const [connStatus, setConnStatus] = useState("INIT");

            useEffect(() => {
                const initSync = setInterval(() => {
                    if (window.db && window.fb) {
                        clearInterval(initSync);
                        setConnStatus("CONNECTING...");
                        
                        try {
                            const q = window.fb.query(
                                window.fb.collection(window.db, "links"), 
                                window.fb.orderBy("createdAt", "desc")
                            );
                            
                            const unsub = window.fb.onSnapshot(q, (snapshot) => {
                                setLinks(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                                setConnStatus("ONLINE");
                                setErrorLog("");
                            }, (err) => {
                                setConnStatus("ERROR");
                                setErrorLog(`DB Error: ${err.code}`);
                            });

                            window.fb.onAuthStateChanged(window.auth, (user) => {
                                setIsAdmin(!!user);
                                if (user) setErrorLog(`Auth: Logged in as ${user.email}`);
                            });

                        } catch (e) {
                            setErrorLog(`Init Failure: ${e.message}`);
                        }
                    }
                }, 500);
            }, []);

            const handleLogin = async (e) => {
                e.preventDefault();
                setErrorLog("Authenticating...");
                try {
                    await window.fb.signInWithEmailAndPassword(window.auth, email, password);
                    setShowLogin(false);
                } catch (err) { 
                    setErrorLog(`Auth Error: ${err.code}`);
                    if (err.code === 'auth/unauthorized-domain') {
                        setErrorLog("BLOCKED: joshpthegeek.github.io is not authorized in Firebase Console.");
                    }
                }
            };

            const addEncounter = async () => {
                if (!isAdmin) return;
                const id = Date.now().toString();
                try {
                    await window.fb.setDoc(window.fb.doc(window.db, "links", id), {
                        id, 
                        zone: "NEW ROUTE", 
                        p1: "???", 
                        p2: "???", 
                        status: "alive", 
                        createdAt: Date.now()
                    });
                } catch (e) {
                    setErrorLog(`Write Error: ${e.code}`);
                }
            };

            const toggleStatus = (link) => {
                if (!isAdmin) return;
                window.fb.setDoc(window.fb.doc(window.db, "links", link.id), {
                    status: link.status === 'dead' ? 'alive' : 'dead'
                }, { merge: true });
            };

            const updateField = (id, field, value) => {
                if (!isAdmin) return;
                window.fb.setDoc(window.fb.doc(window.db, "links", id), { [field]: value }, { merge: true });
            };

            return (
                <div className="max-w-md mx-auto bg-[#2d1b4e] min-h-screen border-x-8 border-black shadow-2xl relative flex flex-col">
                    {/* Top Status Bar */}
                    <div className={`p-2 text-[7px] text-center text-white flex justify-between px-4 ${connStatus === 'ONLINE' ? 'bg-green-600' : 'bg-red-600'}`}>
                        <span>SYS: {connStatus}</span>
                        <span>{isAdmin ? "MODE: ADMIN" : "MODE: SPECTATOR"}</span>
                    </div>

                    {/* Header */}
                    <div className="p-4 flex justify-between items-center border-b-4 border-black bg-[#506880]">
                        <h1 className="text-white text-[10px] tracking-tight">SOUL LINK LIVE</h1>
                        <button 
                            onClick={() => isAdmin ? window.fb.signOut(window.auth) : setShowLogin(true)} 
                            className="bg-white px-3 py-2 border-2 border-black text-[8px] active:translate-y-1 active:shadow-none shadow-[2px_2px_0_#000]"
                        >
                            {isAdmin ? "LOGOUT" : "LOGIN"}
                        </button>
                    </div>

                    {/* Game Screen */}
                    <div className="gba-screen p-4 flex-grow overflow-y-auto">
                        <div className="scanline" style={{top: '20%'}}></div>
                        
                        {links.length === 0 && connStatus === "ONLINE" && (
                            <div className="text-center mt-20 text-[8px] opacity-40">NO SAVED DATA</div>
                        )}

                        {links.map(link => (
                            <div key={link.id} className={`p-4 mb-4 border-4 border-black bg-white pixel-shadow relative transition-all ${link.status === 'dead' ? 'status-dead' : ''}`}>
                                <div className="mb-3 flex items-center gap-2">
                                    <span className="text-[6px] text-gray-400">LOC:</span>
                                    <input 
                                        className="bg-transparent border-b-2 border-dotted border-gray-300 w-full uppercase text-[10px] font-bold text-indigo-900"
                                        value={link.zone}
                                        onChange={(e) => updateField(link.id, 'zone', e.target.value)}
                                        readOnly={!isAdmin}
                                    />
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-red-50 p-2 border-2 border-red-200 rounded">
                                        <div className="text-[6px] text-red-400 mb-1">FIRE RED</div>
                                        <input 
                                            className="bg-transparent w-full text-[8px] uppercase" 
                                            value={link.p1} 
                                            onChange={(e) => updateField(link.id, 'p1', e.target.value)}
                                            readOnly={!isAdmin} 
                                        />
                                    </div>
                                    <div className="bg-green-50 p-2 border-2 border-green-200 rounded">
                                        <div className="text-[6px] text-green-400 mb-1">LEAF GREEN</div>
                                        <input 
                                            className="bg-transparent w-full text-[8px] uppercase" 
                                            value={link.p2} 
                                            onChange={(e) => updateField(link.id, 'p2', e.target.value)}
                                            readOnly={!isAdmin} 
                                        />
                                    </div>
                                </div>

                                {isAdmin && (
                                    <div className="mt-3 flex justify-between items-center pt-2 border-t border-gray-100">
                                        <button 
                                            onClick={() => toggleStatus(link)} 
                                            className={`text-[7px] p-2 border-2 border-black font-bold ${link.status === 'dead' ? 'bg-green-400' : 'bg-red-500 text-white'}`}
                                        >
                                            {link.status === 'dead' ? 'REVIVE' : 'MARK DEAD'}
                                        </button>
                                        <button 
                                            onClick={() => confirm("Release PKMN?") && window.fb.deleteDoc(window.fb.doc(window.db, "links", link.id))} 
                                            className="text-[6px] text-gray-400 underline"
                                        >
                                            RELEASE
                                        </button>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>

                    {/* Admin Footer */}
                    {isAdmin && (
                        <div className="p-4 bg-[#2d1b4e] border-t-4 border-black sticky bottom-0 z-50">
                            <button 
                                onClick={addEncounter} 
                                className="w-full bg-yellow-400 py-4 border-4 border-black text-[10px] font-bold shadow-[4px_4px_0_#000] active:translate-y-1 active:shadow-none"
                            >
                                + NEW ENCOUNTER
                            </button>
                        </div>
                    )}

                    {/* Error Console (For Debugging the Domain issue) */}
                    {errorLog && (
                        <div className="bg-black text-white p-2 text-[6px] fixed bottom-0 left-0 right-0 z-[200] opacity-90 max-w-md mx-auto">
                            CONSOLE: {errorLog}
                        </div>
                    )}

                    {/* Login Modal */}
                    {showLogin && (
                        <div className="fixed inset-0 bg-black/90 z-[300] flex items-center justify-center p-6">
                            <form onSubmit={handleLogin} className="bg-white p-6 border-4 border-black w-full max-w-xs pixel-shadow">
                                <h2 className="text-[10px] mb-4 font-bold">ADMIN LOGIN</h2>
                                <input 
                                    type="text" 
                                    placeholder="EMAIL" 
                                    className="w-full mb-4 p-2 border-2 border-black text-[10px]" 
                                    onChange={e => setEmail(e.target.value)} 
                                />
                                <input 
                                    type="password" 
                                    placeholder="PASSWORD" 
                                    className="w-full mb-4 p-2 border-2 border-black text-[10px]" 
                                    onChange={e => setPassword(e.target.value)} 
                                />
                                <button className="w-full bg-blue-600 text-white py-3 border-2 border-black text-[10px]">SIGN IN</button>
                                <button 
                                    type="button" 
                                    onClick={() => setShowLogin(false)} 
                                    className="w-full mt-4 text-[8px] text-gray-500 underline"
                                >
                                    BACK
                                </button>
                            </form>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
