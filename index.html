<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soul Link Nuzlocke: Live Sync</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --gba-purple: #2d1b4e;
            --gba-screen-bg: #e0f8cf;
            --pkmn-red: #cc0000;
            --pkmn-blue: #3b4cca;
        }

        body {
            font-family: 'Press Start 2P', cursive;
            background-color: #202020;
            background-image: 
                linear-gradient(45deg, #252525 25%, transparent 25%), 
                linear-gradient(-45deg, #252525 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #252525 75%), 
                linear-gradient(-45deg, transparent 75%, #252525 75%);
            background-size: 40px 40px;
            color: #333;
            overflow-x: hidden;
        }

        input[type="text"], input[type="password"] {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.65rem;
            outline: none;
            background: rgba(255,255,255,0.7);
            border: 2px solid #a0a0a0;
            padding: 8px;
            width: 100%;
            border-radius: 4px;
        }

        .status-dead {
            filter: grayscale(100%) contrast(0.8);
            opacity: 0.8;
            background-color: #d1d1d1 !important;
            border-color: #666 !important;
        }
        
        .status-dead input { text-decoration: line-through; color: #777; }

        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
        .animate-happy { animation: bounce 2s infinite; }
        .pixel-shadow { box-shadow: 4px 4px 0 rgba(0,0,0,0.4); }
        .screen-container { position: relative; overflow-y: auto; }

        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .notification-banner { animation: slideUp 0.3s ease-out; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, collection, query, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        // IMPORTANT: Ensure these match your project settings exactly
        const firebaseConfig = {
            apiKey: "AIzaSyCX6il-7t1C_mFOQq8KEL_NuOIYOGKpgws",
            authDomain: "josh-and-tom-nuzlocke.firebaseapp.com",
            projectId: "josh-and-tom-nuzlocke",
            storageBucket: "josh-and-tom-nuzlocke.firebasestorage.app",
            messagingSenderId: "596955970030",
            appId: "1:596955970030:web:4296388a8c62a3375eb6ff"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        window.db = db;
        window.auth = auth;
        window.fb = { collection, doc, onSnapshot, setDoc, query, orderBy, deleteDoc, signInWithEmailAndPassword, onAuthStateChanged, signOut };
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const HappyFaceIcon = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" className="text-yellow-500 animate-happy">
                <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5-9h2v2H7zm8 0h2v2h-2zm-4 4c-2.33 0-4.31 1.46-5.11 3.5h10.22c-.8-2.04-2.78-3.5-5.11-3.5z"/>
            </svg>
        );

        const SkullIcon = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" className="text-gray-700">
                <path fill="currentColor" d="M12 2c-4.42 0-8 3.58-8 8 0 2.23.91 4.24 2.38 5.71L5 18h14l-1.38-2.29C19.09 14.24 20 12.23 20 10c0-4.42-3.58-8-8-8zm0 10c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm-4-2c0-1.1.9-2 2-2s2 .9 2 2-.9 2-2 2 .9 2 2 2z"/>
            </svg>
        );

        const SoulLinkRow = ({ link, isAdmin, onUpdate, onDelete, addNotification }) => {
            const isDead = link.status === 'dead';
            const [localLink, setLocalLink] = useState(link);
            const [isSaving, setIsSaving] = useState(false);

            useEffect(() => { setLocalLink(link); }, [link]);

            const handleUpdate = async (updates) => {
                if (!isAdmin) return;
                setIsSaving(true);
                try {
                    await onUpdate(link.id, { ...localLink, ...updates });
                    addNotification("SYNCED", "success");
                } catch (e) {
                    addNotification("ERROR: " + e.code, "error");
                } finally {
                    setIsSaving(false);
                }
            };

            return (
                <div className={`relative p-3 mb-4 border-4 rounded-sm pixel-shadow transition-all ${isDead ? 'status-dead border-gray-600 bg-gray-200' : 'border-indigo-900 bg-white'}`}>
                    <div className="flex justify-between items-center mb-3 border-b-2 border-gray-200 pb-2">
                        <div className="flex-1 mr-4">
                            <label className="text-[7px] text-gray-500 block mb-1">LOCATION / ROUTE</label>
                            <input 
                                readOnly={!isAdmin} 
                                className="font-bold text-indigo-900 uppercase bg-transparent w-full" 
                                value={localLink.zone} 
                                onChange={e => setLocalLink({...localLink, zone: e.target.value})}
                                onBlur={() => handleUpdate({})} 
                            />
                        </div>
                        <button 
                            disabled={!isAdmin || isSaving}
                            onClick={() => handleUpdate({ status: isDead ? 'alive' : 'dead' })} 
                            className={`flex flex-col items-center p-2 rounded border-2 ${isDead ? 'bg-gray-300 border-gray-400' : 'bg-yellow-50 border-yellow-400'}`}
                        >
                            {isDead ? <SkullIcon /> : <HappyFaceIcon />}
                            <span className="text-[6px] mt-1 font-bold">{isDead ? "RIP" : "LIVE"}</span>
                        </button>
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                        <div className="bg-red-50 p-2 border border-red-200">
                            <label className="text-[6px] font-bold text-red-800 block mb-1">FIRE RED</label>
                            <input 
                                readOnly={!isAdmin} 
                                className="bg-transparent w-full text-[10px] focus:underline" 
                                value={localLink.p1} 
                                onChange={e => setLocalLink({...localLink, p1: e.target.value})}
                                onBlur={() => handleUpdate({})}
                            />
                        </div>
                        <div className="bg-green-50 p-2 border border-green-200">
                            <label className="text-[6px] font-bold text-green-800 block mb-1">LEAF GREEN</label>
                            <input 
                                readOnly={!isAdmin} 
                                className="bg-transparent w-full text-[10px] focus:underline" 
                                value={localLink.p2} 
                                onChange={e => setLocalLink({...localLink, p2: e.target.value})}
                                onBlur={() => handleUpdate({})}
                            />
                        </div>
                    </div>

                    {isAdmin && (
                        <div className="flex justify-end mt-2">
                            <button 
                                onClick={() => confirm("Release this link?") && onDelete(link.id)} 
                                className="bg-red-500 text-white p-1 text-[8px] border border-black"
                            >DELETE</button>
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [links, setLinks] = useState([]);
            const [isAdmin, setIsAdmin] = useState(false);
            const [showLogin, setShowLogin] = useState(false);
            const [email, setEmail] = useState("");
            const [password, setPassword] = useState("");
            const [notifications, setNotifications] = useState([]);
            const [connStatus, setConnStatus] = useState("INITIALIZING");

            const addNotification = (message, type) => {
                const id = Date.now();
                setNotifications(prev => [...prev, { id, message, type }]);
                setTimeout(() => setNotifications(prev => prev.filter(n => n.id !== id)), 2500);
            };

            useEffect(() => {
                const checkFB = setInterval(() => {
                    if (window.db && window.fb) {
                        clearInterval(checkFB);
                        setConnStatus("CONNECTING...");
                        
                        const q = window.fb.query(window.fb.collection(window.db, "links"), window.fb.orderBy("createdAt", "desc"));
                        const unsub = window.fb.onSnapshot(q, (snapshot) => {
                            setLinks(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                            setConnStatus("ONLINE");
                        }, (err) => {
                            setConnStatus("ERROR");
                            console.error(err);
                        });

                        window.fb.onAuthStateChanged(window.auth, (user) => setIsAdmin(!!user));
                    }
                }, 500);
            }, []);

            const handleLogin = async (e) => {
                e.preventDefault();
                try {
                    await window.fb.signInWithEmailAndPassword(window.auth, email, password);
                    setShowLogin(false);
                    addNotification("WELCOME BACK", "success");
                } catch (err) { addNotification("LOGIN FAILED", "error"); }
            };

            const addNewLink = async () => {
                if (!isAdmin) return;
                const id = Date.now().toString();
                try {
                    await window.fb.setDoc(window.fb.doc(window.db, "links", id), {
                        id, zone: "NEW ROUTE", p1: "???", p2: "???", status: "alive", createdAt: Date.now()
                    });
                    addNotification("LINK CREATED", "success");
                } catch (e) { addNotification("DB ERROR", "error"); }
            };

            return (
                <div className="min-h-screen pb-24 max-w-lg mx-auto bg-[#2d1b4e] border-x-4 border-[#1a1030] shadow-2xl relative">
                    {/* Status Bar */}
                    <div className={`text-[6px] p-1 text-center font-bold sticky top-0 z-[100] text-white ${connStatus === 'ONLINE' ? 'bg-green-600' : 'bg-red-600'}`}>
                        DATABASE: {connStatus} {isAdmin ? "(ADMIN MODE)" : "(VIEW ONLY)"}
                    </div>

                    <div className="bg-[#506880] p-4 flex justify-between items-center border-b-4 border-[#1a1030]">
                        <h1 className="text-white text-[10px]">SOUL LINK SYNC</h1>
                        <button onClick={() => isAdmin ? window.fb.signOut(window.auth) : setShowLogin(true)} className="bg-gray-800 text-white p-2 border-2 border-black text-[8px]">
                            {isAdmin ? "EXIT" : "LOGIN"}
                        </button>
                    </div>

                    <div className="p-4 bg-[#e0f8cf] min-h-[80vh] screen-container">
                        {links.length === 0 && connStatus === "ONLINE" && (
                            <div className="text-center py-20 opacity-30 text-[8px]">NO LINKS FOUND</div>
                        )}
                        {links.map(l => (
                            <SoulLinkRow 
                                key={l.id} 
                                link={l} 
                                isAdmin={isAdmin} 
                                addNotification={addNotification}
                                onUpdate={(id, data) => window.fb.setDoc(window.fb.doc(window.db, "links", id), data, {merge: true})}
                                onDelete={id => window.fb.deleteDoc(window.fb.doc(window.db, "links", id))}
                            />
                        ))}
                    </div>

                    {isAdmin && (
                        <div className="fixed bottom-0 left-0 right-0 p-4 bg-[#2d1b4e] border-t-4 border-[#1a1030] max-w-lg mx-auto z-40">
                            <button onClick={addNewLink} className="w-full bg-white text-indigo-900 font-bold py-4 border-2 border-black pixel-shadow active:translate-y-1 active:shadow-none text-[10px]">
                                + ADD NEW ENCOUNTER
                            </button>
                        </div>
                    )}

                    {/* Notifications */}
                    <div className="fixed bottom-24 left-1/2 -translate-x-1/2 w-full max-w-xs z-[60] flex flex-col gap-2 p-4">
                        {notifications.map(n => (
                            <div key={n.id} className={`p-3 border-2 border-black pixel-shadow text-[8px] font-bold text-center ${n.type === 'success' ? 'bg-green-400' : 'bg-red-400'}`}>
                                {n.message}
                            </div>
                        ))}
                    </div>

                    {showLogin && (
                        <div className="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4">
                            <form onSubmit={handleLogin} className="bg-white p-6 border-4 border-black w-full max-w-xs pixel-shadow">
                                <h2 className="text-[10px] mb-4 font-bold uppercase">Admin Access</h2>
                                <input type="text" placeholder="EMAIL" className="mb-4" onChange={e => setEmail(e.target.value)} />
                                <input type="password" placeholder="PASSWORD" className="mb-4" onChange={e => setPassword(e.target.value)} />
                                <button className="w-full bg-blue-600 text-white py-3 text-[10px] font-bold border-2 border-black">LOG IN</button>
                                <button type="button" onClick={() => setShowLogin(false)} className="w-full mt-4 text-[8px] text-gray-400 underline">CANCEL</button>
                            </form>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
