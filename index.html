<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soul Link Sync: Retro Edition</title>
    <!-- React & Tailwind -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --gba-purple: #2d1b4e;
            --gba-screen-bg: #e0f8cf;
            --pkmn-red: #cc0000;
            --pkmn-blue: #3b4cca;
            --pkmn-ui-blue: #3050c0;
        }

        body {
            font-family: 'Press Start 2P', cursive;
            background-color: #202020;
            /* Retro checkered background */
            background-image: 
                linear-gradient(45deg, #252525 25%, transparent 25%), 
                linear-gradient(-45deg, #252525 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #252525 75%), 
                linear-gradient(-45deg, transparent 75%, #252525 75%);
            background-size: 40px 40px;
            color: #333;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        input {
            font-family: 'Press Start 2P', cursive;
            outline: none;
        }

        input[type="text"] {
            font-size: 0.65rem;
            background: rgba(255,255,255,0.5);
            border: 2px solid transparent;
            border-bottom: 2px solid #a0a0a0;
            padding: 6px;
            width: 100%;
            border-radius: 4px;
            transition: all 0.2s;
        }
        input[type="text"]:focus {
            background: white;
            border-bottom-color: var(--pkmn-ui-blue);
        }

        .pixel-shadow { box-shadow: 4px 4px 0 rgba(0,0,0,0.5); }
        
        .gba-screen { 
            background-color: var(--gba-screen-bg); 
            min-height: 75vh; 
            position: relative;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.2);
        }

        .status-dead {
            filter: grayscale(100%) contrast(1.1);
            opacity: 0.8;
            background-color: #dcdcdc !important;
            border-color: #555 !important;
        }
        .status-dead input { text-decoration: line-through; color: #555; }

        /* LCD Grid/Scanline effect */
        .lcd-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            opacity: 0.1;
            background-image: 
                linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            z-index: 10;
        }

        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
        .animate-happy { animation: bounce 2s infinite; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #2d1b4e; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, collection, query, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCX6il-7t1C_mFOQq8KEL_NuOIYOGKpgws",
            authDomain: "josh-and-tom-nuzlocke.firebaseapp.com",
            projectId: "josh-and-tom-nuzlocke",
            storageBucket: "josh-and-tom-nuzlocke.firebasestorage.app",
            messagingSenderId: "5969970030",
            appId: "1:596955970030:web:4296388aa3375eb6ff"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        window.db = db;
        window.auth = auth;
        window.fb = { collection, doc, onSnapshot, setDoc, query, orderBy, deleteDoc, signInWithEmailAndPassword, onAuthStateChanged, signOut };
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- AUDIO ENGINE ---
        const AudioEngine = {
            ctx: null,
            init: () => {
                if (!AudioEngine.ctx) AudioEngine.ctx = new (window.AudioContext || window.webkitAudioContext)();
            },
            play: (type) => {
                AudioEngine.init();
                const ctx = AudioEngine.ctx;
                if(ctx.state === 'suspended') ctx.resume();
                
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                const now = ctx.currentTime;

                if (type === 'tap') {
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(400, now);
                    osc.frequency.exponentialRampToValueAtTime(600, now + 0.05);
                    gain.gain.setValueAtTime(0.05, now);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
                    osc.start(now);
                    osc.stop(now + 0.05);
                } else if (type === 'dead') {
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(150, now);
                    osc.frequency.linearRampToValueAtTime(80, now + 0.4);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.4);
                    osc.start(now);
                    osc.stop(now + 0.4);
                } else if (type === 'revive') {
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(440, now);
                    osc.frequency.linearRampToValueAtTime(880, now + 0.1);
                    osc.frequency.linearRampToValueAtTime(1200, now + 0.2);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.3);
                    osc.start(now);
                    osc.stop(now + 0.3);
                }
            }
        };

        // --- ICONS ---
        const HappyFaceIcon = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" className="text-yellow-500 animate-happy filter drop-shadow-sm">
                <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5-9h2v2H7zm8 0h2v2h-2zm-4 4c-2.33 0-4.31 1.46-5.11 3.5h10.22c-.8-2.04-2.78-3.5-5.11-3.5z"/>
                <circle cx="5.5" cy="13.5" r="1.5" fill="#ff4444" opacity="0.6" />
                <circle cx="18.5" cy="13.5" r="1.5" fill="#ff4444" opacity="0.6" />
            </svg>
        );

        const SkullIcon = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" className="text-gray-700">
                <path fill="currentColor" d="M12 2c-4.42 0-8 3.58-8 8 0 2.23.91 4.24 2.38 5.71L5 18h14l-1.38-2.29C19.09 14.24 20 12.23 20 10c0-4.42-3.58-8-8-8zm0 10c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm-4-2c0-1.1.9-2 2-2s2 .9 2 2-.9 2-2 2 .9 2 2 2z"/>
                <path fill="currentColor" d="M8 19h2v3H8zm6 0h2v3h-2z"/>
            </svg>
        );

        const SoulLinkRow = ({ link, isAdmin, onUpdate, onDelete }) => {
            const isDead = link.status === 'dead';

            const toggleStatus = () => {
                if (!isAdmin) return;
                const newStatus = isDead ? 'alive' : 'dead';
                AudioEngine.play(newStatus === 'dead' ? 'dead' : 'revive');
                onUpdate(link.id, 'status', newStatus);
            };

            return (
                <div className={`p-3 mb-4 border-4 rounded-sm transition-all duration-300 pixel-shadow relative ${isDead ? 'status-dead border-gray-600 bg-gray-200' : 'border-indigo-900 bg-white'}`}>
                    <div className="flex justify-between items-start mb-3 border-b-2 border-gray-200 pb-2">
                        <div className="w-2/3">
                            <label className="text-[8px] text-gray-500 uppercase block mb-1 tracking-widest">Zone / Route</label>
                            <input 
                                type="text"
                                className="font-bold text-indigo-900 uppercase bg-transparent"
                                value={link.zone}
                                placeholder="e.g. Route 1"
                                onChange={(e) => onUpdate(link.id, 'zone', e.target.value)}
                                readOnly={!isAdmin}
                            />
                        </div>
                        <button 
                            onClick={toggleStatus} 
                            disabled={!isAdmin} 
                            className={`flex flex-col items-center justify-center p-2 rounded-md border-2 transition-transform active:scale-95 ${isDead ? 'bg-gray-300 border-gray-500 text-gray-600' : 'bg-yellow-100 border-yellow-400 text-yellow-800 hover:bg-yellow-200'}`}
                        >
                            {isDead ? <SkullIcon /> : <HappyFaceIcon />}
                            <span className="text-[8px] mt-1 font-bold">{isDead ? "DEAD" : "ALIVE"}</span>
                        </button>
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                        <div className="bg-red-50 p-2 border border-red-100 rounded">
                            <div className="flex items-center gap-2 mb-1">
                                <div className="w-2 h-2 bg-red-500 rounded-full border border-black"></div>
                                <label className="text-[7px] font-bold text-red-800">FIRE RED</label>
                            </div>
                            <input 
                                type="text"
                                className="bg-transparent uppercase"
                                value={link.p1}
                                placeholder="Pokemon..."
                                onChange={(e) => onUpdate(link.id, 'p1', e.target.value)}
                                readOnly={!isAdmin} 
                            />
                        </div>
                        <div className="bg-green-50 p-2 border border-green-100 rounded">
                            <div className="flex items-center gap-2 mb-1">
                                <div className="w-2 h-2 bg-green-500 rounded-full border border-black"></div>
                                <label className="text-[7px] font-bold text-green-800">LEAF GREEN</label>
                            </div>
                            <input 
                                type="text"
                                className="bg-transparent uppercase"
                                value={link.p2}
                                placeholder="Pokemon..."
                                onChange={(e) => onUpdate(link.id, 'p2', e.target.value)}
                                readOnly={!isAdmin} 
                            />
                        </div>
                    </div>
                    {isAdmin && (
                        <button 
                            onClick={() => confirm("Release PKMN permanently?") && onDelete(link.id)} 
                            className="absolute -top-3 -right-2 bg-red-600 hover:bg-red-700 text-white p-1 border-2 border-black shadow-md active:translate-y-1"
                        >
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="white"><path d="M3 6l3 18h12l3-18h-18zm19-4v2h-20v-2h5.711c.9 0 1.631-1.099 1.631-2h5.316c0 .901.73 2 1.631 2h5.711z"/></svg>
                        </button>
                    )}
                </div>
            );
        };

        const App = () => {
            const [links, setLinks] = useState([]);
            const [isAdmin, setIsAdmin] = useState(false);
            const [showLogin, setShowLogin] = useState(false);
            const [email, setEmail] = useState("");
            const [password, setPassword] = useState("");
            const [errorLog, setErrorLog] = useState("");
            const [connStatus, setConnStatus] = useState("INIT");

            useEffect(() => {
                const initSync = setInterval(() => {
                    if (window.db && window.fb) {
                        clearInterval(initSync);
                        setConnStatus("CONNECTING...");
                        try {
                            const q = window.fb.query(window.fb.collection(window.db, "links"), window.fb.orderBy("createdAt", "desc"));
                            const unsub = window.fb.onSnapshot(q, (snapshot) => {
                                setLinks(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                                setConnStatus("ONLINE");
                                setErrorLog("");
                            }, (err) => {
                                setConnStatus("ERROR");
                                if (err.message.toLowerCase().includes('referer')) {
                                    setErrorLog("API KEY BLOCKED: In Google Cloud Console, ensure 'joshpthegeek.github.io/*' is allowed.");
                                } else {
                                    setErrorLog(`DB Error: ${err.code}`);
                                }
                            });
                            window.fb.onAuthStateChanged(window.auth, (user) => setIsAdmin(!!user));
                        } catch (e) { setErrorLog(`Init Failure: ${e.message}`); }
                    }
                }, 500);
            }, []);

            const handleLogin = async (e) => {
                e.preventDefault();
                setErrorLog("SIGNING IN...");
                try {
                    await window.fb.signInWithEmailAndPassword(window.auth, email, password);
                    setShowLogin(false);
                    setErrorLog("");
                } catch (err) {
                    setErrorLog(`LOGIN FAILED: ${err.code}`);
                }
            };

            const addEncounter = async () => {
                if (!isAdmin) return;
                AudioEngine.play('tap');
                const id = Date.now().toString();
                try {
                    await window.fb.setDoc(window.fb.doc(window.db, "links", id), {
                        id, zone: "", p1: "", p2: "", status: "alive", createdAt: Date.now()
                    });
                } catch (e) { setErrorLog(`Write Error: ${e.code}`); }
            };

            const updateField = (id, field, value) => {
                if (!isAdmin) return;
                window.fb.setDoc(window.fb.doc(window.db, "links", id), { [field]: value }, { merge: true });
            };

            const deleteLink = (id) => {
                if (!isAdmin) return;
                AudioEngine.play('dead');
                window.fb.deleteDoc(window.fb.doc(window.db, "links", id));
            };

            const aliveCount = links.filter(l => l.status === 'alive').length;
            const deadCount = links.filter(l => l.status === 'dead').length;

            return (
                <div className="max-w-lg mx-auto bg-[#2d1b4e] min-h-screen border-x-4 border-[#1a1030] shadow-2xl relative flex flex-col">
                    {/* Status Monitor */}
                    <div className={`p-1 text-[7px] text-center text-white flex justify-between px-4 sticky top-0 z-[100] ${connStatus === 'ONLINE' ? 'bg-green-600' : 'bg-red-600'}`}>
                        <span>DATABASE: {connStatus}</span>
                        <span>ALIVE: {aliveCount} | DEAD: {deadCount}</span>
                    </div>

                    {/* Retro Header */}
                    <div className="bg-[#506880] p-4 border-b-8 border-[#2d1b4e] flex justify-between items-center shadow-lg sticky top-6 z-40">
                        <div className="flex flex-col">
                            <h1 className="text-white text-[10px] tracking-widest uppercase">Soul Link Live</h1>
                            <span className="text-white opacity-50 text-[6px] mt-1">{isAdmin ? "ADMIN CONTROL" : "SPECTATOR MODE"}</span>
                        </div>
                        <button onClick={() => isAdmin ? window.fb.signOut(window.auth) : setShowLogin(true)} className="bg-gray-700 text-white p-2 border-2 border-gray-900 text-[8px] active:scale-95 shadow-[2px_2px_0_#000]">
                            {isAdmin ? "EXIT" : "LOGIN"}
                        </button>
                    </div>

                    {/* Game Screen Content */}
                    <div className="gba-screen p-4 flex-grow overflow-y-auto">
                        <div className="lcd-overlay"></div>
                        
                        {links.length === 0 && connStatus === "ONLINE" && (
                            <div className="text-center py-20 opacity-30 uppercase">
                                <p className="text-[10px] mb-2">No Links Saved</p>
                                <p className="text-[6px]">Start a new encounter below</p>
                            </div>
                        )}

                        <div className="space-y-4 pb-20 relative z-20">
                            {links.map(link => (
                                <SoulLinkRow 
                                    key={link.id}
                                    link={link}
                                    isAdmin={isAdmin}
                                    onUpdate={updateField}
                                    onDelete={deleteLink}
                                />
                            ))}
                        </div>
                    </div>

                    {/* Admin Action Bar */}
                    {isAdmin && (
                        <div className="p-4 bg-[#2d1b4e] border-t-4 border-[#1a1030] sticky bottom-0 z-50">
                            <button onClick={addEncounter} className="w-full bg-[#f0f0f0] text-[#2d1b4e] font-bold py-4 border-4 border-black pixel-shadow active:translate-y-1 active:shadow-none text-[10px] tracking-widest uppercase flex items-center justify-center gap-3">
                                <div className="w-6 h-6 rounded-full border-2 border-black flex items-center justify-center bg-red-500 text-white leading-none pb-0.5">+</div>
                                <span>NEW ENCOUNTER</span>
                            </button>
                        </div>
                    )}

                    {/* Global Log / Error Console */}
                    {errorLog && (
                        <div className="bg-black text-white p-3 text-[7px] fixed bottom-0 left-0 right-0 z-[200] opacity-95 max-w-lg mx-auto border-t-2 border-red-500">
                            SYSTEM LOG: {errorLog}
                        </div>
                    )}

                    {/* Modal: Admin Login */}
                    {showLogin && (
                        <div className="fixed inset-0 bg-black/90 z-[300] flex items-center justify-center p-6">
                            <form onSubmit={handleLogin} className="bg-white p-6 border-4 border-black w-full max-w-xs pixel-shadow">
                                <h2 className="text-[10px] mb-6 font-bold uppercase tracking-tighter">Enter Admin Card</h2>
                                <input type="text" placeholder="EMAIL" className="w-full mb-4 p-3 border-2 border-black text-[10px] bg-gray-50" onChange={e => setEmail(e.target.value)} />
                                <input type="password" placeholder="PASSWORD" className="w-full mb-6 p-3 border-2 border-black text-[10px] bg-gray-50" onChange={e => setPassword(e.target.value)} />
                                <button className="w-full bg-blue-600 text-white py-3 border-2 border-black text-[10px] font-bold shadow-[3px_3px_0_#000] active:translate-y-1 active:shadow-none">SIGN IN</button>
                                <button type="button" onClick={() => setShowLogin(false)} className="w-full mt-4 text-[8px] text-gray-500 underline uppercase">Cancel</button>
                            </form>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
