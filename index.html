<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soul Link Nuzlocke: Live Sync</title>
    <!-- React & Tailwind -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --gba-purple: #2d1b4e;
            --gba-screen-bg: #e0f8cf;
            --pkmn-ui-blue: #3050c0;
        }
        body {
            font-family: 'Press Start 2P', cursive;
            background-color: #202020;
            background-image: 
                linear-gradient(45deg, #252525 25%, transparent 25%), 
                linear-gradient(-45deg, #252525 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #252525 75%), 
                linear-gradient(-45deg, transparent 75%, #252525 75%);
            background-size: 40px 40px;
            color: #333;
            overflow-x: hidden;
        }
        input[type="text"], input[type="password"] {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.65rem;
            outline: none;
            background: rgba(255,255,255,0.5);
            border-bottom: 2px solid #a0a0a0;
            padding: 6px;
            width: 100%;
        }
        .status-dead { filter: grayscale(100%); opacity: 0.8; background-color: #dcdcdc !important; }
        .pixel-shadow { box-shadow: 4px 4px 0 rgba(0,0,0,0.3); }
        .screen-container { box-shadow: inset 0 0 20px rgba(0,0,0,0.2); position: relative; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- This script handles the React UI and Firebase logic together using Babel -->
    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, collection, query, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCX6il-7t1C_mFOQq8KEL_NuOIYOGKpgws",
            authDomain: "josh-and-tom-nuzlocke.firebaseapp.com",
            projectId: "josh-and-tom-nuzlocke",
            storageBucket: "josh-and-tom-nuzlocke.firebasestorage.app",
            messagingSenderId: "596955970030",
            appId: ":596955970030:web:4296388a8c62a3375eb6ff"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const { useState, useEffect } = React;

        const SoulLinkRow = ({ link, isAdmin, onUpdate, onDelete }) => {
            const isDead = link.status === 'dead';
            return (
                <div className={`p-3 mb-4 border-4 rounded-sm pixel-shadow relative ${isDead ? 'status-dead bg-gray-200' : 'border-indigo-900 bg-white'}`}>
                    <div className="flex justify-between items-center mb-3">
                        <div className="w-2/3">
                            <input 
                                readOnly={!isAdmin}
                                className="w-full bg-transparent border-none font-bold text-indigo-900 uppercase focus:outline-none"
                                value={link.zone}
                                onChange={(e) => onUpdate(link.id, { ...link, zone: e.target.value })}
                                placeholder="Zone Name"
                            />
                            {link.createdBy && (
                                <div className="text-[6px] text-gray-400 mt-1">ID: {link.createdBy}</div>
                            )}
                        </div>
                        {isAdmin && (
                            <button onClick={() => onUpdate(link.id, { ...link, status: isDead ? 'alive' : 'dead' })}
                                    className="p-1 border-2 border-black bg-yellow-100 text-[8px] font-bold">
                                {isDead ? "REVIVE" : "KILL"}
                            </button>
                        )}
                    </div>
                    <div className="grid grid-cols-2 gap-2">
                        <div className="bg-red-50 p-2 border border-red-200">
                            <label className="text-[7px] block mb-1 text-red-700 font-bold uppercase">Fire Red</label>
                            <input readOnly={!isAdmin} className="bg-transparent w-full text-[10px]" value={link.p1} onChange={(e) => onUpdate(link.id, { ...link, p1: e.target.value })} placeholder="..." />
                        </div>
                        <div className="bg-green-50 p-2 border border-green-200">
                            <label className="text-[7px] block mb-1 text-green-700 font-bold uppercase">Leaf Green</label>
                            <input readOnly={!isAdmin} className="bg-transparent w-full text-[10px]" value={link.p2} onChange={(e) => onUpdate(link.id, { ...link, p2: e.target.value })} placeholder="..." />
                        </div>
                    </div>
                    {isAdmin && (
                        <button onClick={() => { if(confirm("Delete?")) onDelete(link.id) }} className="absolute -top-2 -right-2 bg-red-600 text-white text-[8px] p-1 border border-black font-bold">X</button>
                    )}
                </div>
            );
        };

        const App = () => {
            const [links, setLinks] = useState([]);
            const [isAdmin, setIsAdmin] = useState(false);
            const [user, setUser] = useState(null);
            const [showLogin, setShowLogin] = useState(false);
            const [email, setEmail] = useState("");
            const [password, setPassword] = useState("");

            useEffect(() => {
                const q = query(collection(db, "links"), orderBy("createdAt", "desc"));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setLinks(data);
                });
                const authUnsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    setIsAdmin(!!u);
                });
                return () => {
                    unsubscribe();
                    authUnsubscribe();
                };
            }, []);

            const handleLogin = async (e) => {
                e.preventDefault();
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    setShowLogin(false);
                } catch (err) { alert("Login Failed: " + err.message); }
            };

            const addLink = async () => {
                if (!isAdmin || !user) return;
                const id = Date.now().toString();
                await setDoc(doc(db, "links", id), { 
                    id, 
                    zone: "NEW ROUTE", 
                    p1: "", 
                    p2: "", 
                    status: "alive", 
                    createdAt: Date.now(),
                    createdBy: user.uid // Track who created the encounter
                });
            };

            const updateLink = async (id, data) => {
                if (!isAdmin) return;
                await setDoc(doc(db, "links", id), data, { merge: true });
            };

            const deleteLink = async (id) => {
                if (!isAdmin) return;
                await deleteDoc(doc(db, "links", id));
            };

            return (
                <div className="min-h-screen pb-24 max-w-lg mx-auto bg-[#2d1b4e] shadow-2xl border-x-4 border-[#1a1030]">
                    <div className="bg-[#506880] p-3 border-b-8 border-[#2d1b4e] flex justify-between items-center sticky top-0 z-50 shadow-md">
                        <h1 className="text-white text-[10px] tracking-tighter">SOUL LINK LIVE</h1>
                        <button onClick={() => isAdmin ? signOut(auth) : setShowLogin(true)} className="text-[8px] text-white bg-black/30 p-2 border border-white/20">
                            {isAdmin ? "LOGOUT" : "ADMIN LOGIN"}
                        </button>
                    </div>

                    {showLogin && (
                        <div className="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4">
                            <form onSubmit={handleLogin} className="bg-white p-6 border-4 border-black w-full max-w-xs">
                                <h2 className="text-[10px] mb-4 font-bold uppercase">Admin Login</h2>
                                <input type="text" placeholder="EMAIL" className="mb-4 block w-full p-2 border border-gray-300" onChange={e => setEmail(e.target.value)} />
                                <input type="password" placeholder="PASSWORD" className="mb-4 block w-full p-2 border border-gray-300" onChange={e => setPassword(e.target.value)} />
                                <button className="w-full bg-blue-600 text-white py-3 text-[10px] font-bold">SIGN IN</button>
                                <button type="button" onClick={() => setShowLogin(false)} className="w-full mt-2 text-[8px] text-gray-400">CANCEL</button>
                            </form>
                        </div>
                    )}

                    <div className="p-4 bg-[#e0f8cf] min-h-screen screen-container">
                        <div className="absolute inset-0 pointer-events-none opacity-5" style={{backgroundImage: 'linear-gradient(rgba(0,0,0,0.2) 50%, transparent 50%)', backgroundSize: '100% 4px'}}></div>
                        {links.length === 0 && <p className="text-center text-[8px] mt-10 text-gray-400">WAITING FOR DATA...</p>}
                        {links.map(l => (
                            <SoulLinkRow key={l.id} link={l} isAdmin={isAdmin} onUpdate={updateLink} onDelete={deleteLink} />
                        ))}
                    </div>

                    {isAdmin && (
                        <div className="fixed bottom-0 left-0 right-0 p-4 bg-[#2d1b4e] max-w-lg mx-auto border-t-4 border-[#1a1030]">
                            <button onClick={addLink} className="w-full bg-white py-4 text-[10px] font-bold border-2 border-black shadow-[4px_4px_0_#000] active:translate-y-1 active:shadow-none transition-all">
                                + ADD NEW ENCOUNTER
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
